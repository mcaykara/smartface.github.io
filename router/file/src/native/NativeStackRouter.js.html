<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/native/NativeStackRouter.js | Smartface NativeRouter</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Smartface NativeRouter"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Smartface NativeRouter"><meta property="twitter:description" content="Smartface NativeRouter"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/smartface/router"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-History">History</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-HistoryListener">HistoryListener</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteBuildHandler">RouteBuildHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteShouldMatchHandler">RouteShouldMatchHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouterBlockHandler">RouterBlockHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.BottomTabBarController">BottomTabbarController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.Color">Color</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.Image">Image</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.NavigationController">NavigationController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.Page">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.TabBarItem">TabBarItem</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#common">common</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createHistory">createHistory</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#native">native</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/AndroidRenderer.js~AndroidRenderer.html">AndroidRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/BottomTabBarRouter.js~BottomTabBarRouter.html">BottomTabBarRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/IOSRenderer.js~IOSRenderer.html">IOSRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/NativeRouter.js~NativeRouter.html">NativeRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/NativeRouterBase.js~NativeRouterBase.html">NativeRouterBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/NativeStackRouter.js~NativeStackRouter.html">NativeStackRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/Renderer.js~Renderer.html">Renderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createTabBarItem">createTabBarItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BottomTabBarItem">BottomTabBarItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BottomTabBarRouterParams">BottomTabBarRouterParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-HeaderBarParams">HeaderBarParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NativeStackRouterParams">NativeStackRouterParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NavigationControllerTransformEvent">NavigationControllerTransformEvent</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#router">router</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/router/Route.js~Route.html">Route</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/router/Route.js~RoutePath.html">RoutePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/router/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteLocation">RouteLocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteMatch">RouteMatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteParams">RouteParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteState">RouteState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouterParams">RouterParams</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/native/NativeStackRouter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&quot;use strict&quot;;

/**
 * @typedef {RouterParams} NativeStackRouterParams
 * @property {Array&lt;BottomTabBarItem&gt;} items BottomTabBarItem collection
 * @property {function():HeaderBarParams} modal
 * @property {function():HeaderBarParams} headerBarParams Properties of NavigationController&apos;s headerbar. See {@link NavigationController}.
 */

/**
 * @typedef {object} HeaderBarParams For more info {@link NavigationController}
 * @property {{ transulent: boolean,
 *              alpha: number,
 *              backIndicatorImage: Image,
 *              backIndicatorTransitionMaskImage: Image,
 *              prefersLargeTitles: boolean}} ios
 * @property {boolean} borderVisibility
 * @property {Color} titleColor
 * @property {boolean} transparent
 * @property {boolean} visible
 * @property {Color} backgroundColor
 */

/**
 * @typedef NavigationControllerTransformEvent
 * @property {Page} frompage
 * @property {Page} topage
 * @property {{operation: number}} operation
 */

const NativeRouterBase = require(&quot;./NativeRouterBase&quot;);
const Router = require(&quot;../router/Router&quot;);
const NavigationController = require(&quot;sf-core/ui/navigationcontroller&quot;);
const createRenderer = require(&quot;./createRenderer&quot;);

/**
 * Creates {@link NavigationController} and manages its behavours and routes.
 *
 * @class
 * @extends {Router}
 * @example
 * const {NativeStackRouter, Route} = require(&apos;@smartface/router&apos;);
 * const Image = require(&apos;sf-core/ui/image&apos;);
 * const Color = require(&apos;sf-core/ui/color&apos;);
 *
 * var router = Router.of({
 *  path: &quot;/&quot;,
 *
 *  routes: [
 *    NativeStackRouter.of(
 *      path: &apos;/pages&apos;,
 *      headerBarParams: () =&gt; ({
 *        ios: {
 *          translucent: true,
 *          alpha: 1
 *        },
 *        backgroundColor: Color.BLUE,
 *        visible: true
 *      }),
 *      routes: [
 *        Route.of({
 *          path: &quot;/pages/page1&quot;,
 *          build((router, route) =&gt; {
 *            const Page1 = require(&apos;/pages/Page1&apos;);
 *            return new Page1(state.data, router);
 *          })
 *        }),
 *        Route.of({
 *          path: &quot;/pages/page2&quot;,
 *          build((router, route) =&gt; {
 *            const Page2 = require(&apos;/pages/Page2&apos;);
 *            return new Page2(state.data, router);
 *          });
 *        });
 *      ]
 *    )]
 * });
 *
 * @example
 * const extend = require(&quot;js-base/core/extend&quot;);
 * const System = require(&quot;sf-core/device/system&quot;);
 * const Application = require(&quot;sf-core/application&quot;);
 * const AlertView = require(&quot;sf-core/ui/alertview&quot;);
 * const {NativeStackRouter} = require(&apos;@smartface/router&apos;);
 *
 * // Get generated UI code
 * const Page1Design = require(&quot;ui/ui_page1&quot;);
 *
 * const Page1 = extend(Page1Design)(
 *   // Constructor
 *   function(_super, data, router) {
 *       // Initalizes super class for this page scope
 *       _super(this);
 *       this._router = router;
 *       if(router instanceof NativeStackRouter)
 *         router.setHeaderBarParams({visible: false});
 *
 *       ...
 *   });
 *
 *
 * @since 1.0.0
 */
class NativeStackRouter extends NativeRouterBase {
  /**
   * Builds OS specific NaitveRouter
   *
   * @static
   * @param {NativeStackRouterParams} params
   */
  static of(params) {
    params.renderer = createRenderer();
    return new NativeStackRouter(params);
  }

  /**
   * @constructor
   * @param {NativeStackRouterParams} param0
   */
  constructor({
    path = &quot;&quot;,
    build = null,
    routes = [],
    exact = false,
    renderer = null,
    to = null,
    isRoot = false,
    modal = false,
    headerBarParams = () =&gt; {},
    routerDidEnter,
    routerDidExit,
    routeWillEnter = null,
    routeShouldMatch,
    homeRoute = null
  }) {
    super({
      path,
      build,
      routes,
      exact,
      modal,
      to,
      isRoot,
      routerDidEnter,
      routerDidExit,
      routeShouldMatch,
      homeRoute,
      routeWillEnter
    });

    this._homeRoute = homeRoute;
    this._headerBarParams = headerBarParams;
    this._renderer = renderer;
    this._renderer.setRootController(new NavigationController());
    this.addNavigatorChangeListener();
    this.build = () =&gt; this._renderer._rootController;
    this._renderer._rootController.headerBar = headerBarParams();
  }

  /**
   * Applies new params to the headerBar
   *
   * @param {HeaderBarParams} params
   */
  setHeaderBarParams(params) {
    this._renderer._rootController.headerBar = params;
  }

  /**
   * Returns headerBar instance
   *
   * @return {object}
   */
  get headerBar() {
    return this._renderer._rootController.headerBar;
  }

  /**
   * @ignore
   * @param {RouteState} prevState
   * @param {RouteState} nextState
   */
  routeShouldMatch(prevState, nextState) {
    if (this.isUrlCurrent(nextState.match.url, nextState.action)) return false;
    return super.routeShouldMatch(prevState, nextState);
  }

  /**
   * Closes StackRouter&apos;s View if it is opened as modal.
   *
   * @param {function} fn - Callback is called before dismissing to trigger another action like routing to an another page.
   */
  dismiss(fn) {
    this._dismiss &amp;&amp; this._dismiss(fn);
  }

  /**
   * To Listen page changes are handled by device.
   *
   * @private
   */
  addNavigatorChangeListener() {
    this._unlistener = this._renderer.onNavigationControllerTransition(
      action =&gt; {
        // if user presses backbutton or uses gesture to back
        if (
          action.operation === NavigationController.OperationType.POP &amp;&amp;
          !this._fromRouter
        ) {
          try {
            // set Router to skip next history change
            this._historyController.preventDefault();
            this._historyController.goBack();
            this.dispatch(
              this._historyController.history.location,
              &quot;POP&quot;,
              this,
              false
            );
          } catch (e) {
            throw e;
          } finally {
          }
        }
      }
    );
  }

  /**
   * @protected
   * @ignore
   * @param {string} path
   */
  pushHomeBefore(path) {
    if (
      this.hasHome() &amp;&amp;
      this._renderer._rootController.childControllers.length === 0
    ) {
      const indexRoute = this._routes[this._homeRoute];

      if (path !== indexRoute.getUrlPath()) {
        this._historyController.push(indexRoute.getUrlPath());
      }
    }

    return true;
  }

  /**
   * @override
   */
  push(path, routeData = {}) {
    return super.push(path, routeData);
  }

  /**
   * @override
   */
  routeWillEnter(route, requestedUrl, act, ex, target, fromRouter) {
    const {
      view,
      match: { isExact: exact },
      url,
      action
    } = route.getState();
    const active = url === this._currentRouteUrl;
    switch (action) {
      case &quot;REPLACE&quot;:
        if (this._fromRouter) {
          this._renderer.replaceChild(
            (route._renderer &amp;&amp; route._renderer._rootController) || view
          );
        }
        break;
      case &quot;PUSH&quot;:
        if (this._fromRouter) {
          if (route.isModal() &amp;&amp; !this._presented &amp;&amp; !active) {
            const lastLocation = Router.getGlobalRouter().history.entries[
              Router.getGlobalRouter().history.index
            ];
            const lastLocationIndex = Router.getGlobalRouter().history.index;
            this._renderer.present(
              (route._renderer &amp;&amp; route._renderer._rootController) || view
            );
            route._dismiss = (cb = null) =&gt; {
              console.log(&quot;dismiss &quot; + route);
              let diff =
                Router.getGlobalRouter().history.index - lastLocationIndex;
              // Rewinds global history as much as visit in the modal.
              // Because routers in the tree are not aware of modal router will be dismissed.
              // And if they are notified and then their current-urls will be outdated.
              while (diff &gt; 1) {
                Router.getGlobalRouter().history.rollback();
                diff--;
              }

              this._historyController.preventDefault();
              this._historyController.goBack();
              // simulate a pop request to inform all routers
              // regarding route changing
              this.dispatch(lastLocation, &quot;POP&quot;, this, false);
              cb &amp;&amp; cb();
              route._renderer.dismiss(() =&gt; {
                route._dismiss = null;
                route._presented = false;
                route._currentRouteUrl = null;
                this._currentRouteUrl = null;

                this._presented = false;
                route.setState({ active: false });
                route.resetView();
              });
            };

            this._presented = true;
            route.setState({ active: true });
          } else if (!route.isModal() &amp;&amp; !active) {
            this._currentRouteUrl = url;
            try {
              this._renderer.pushChild(
                (route._renderer &amp;&amp; route._renderer._rootController) || view
              );
            } catch (e) {
              throw `Error when ${route} is pushed. ${e}`;
            } finally {
              route.setState({ active: true });
            }
          }
        }

        break;
      case &quot;POP&quot;:
        // TODO: Add dismiss logic
        if (this._fromRouter) {
          if (!route._dismiss &amp;&amp; exact) {
            this._renderer.popChild();
          }
        }

        route.setState({ active: false });
        break;
    }
    this._currentRouteUrl = url;
    super.routeWillEnter(route);
  }

  /**
   * Go back to index
   * @example
   * ...
   * router.goBackto(-2)
   * ...
   * @since 1.1.0
   * @param {number} n Amount of back as negative value. If stack length shorter than specified number then the active router does nothing.
   */
  goBackto(n) {
    if (this._historyController.canGoBack(n)) {
      const back = this._historyController.currentIndex() + n;
      const location = this._historyController.find(
        (location, index) =&gt; index === back
      );
      this._historyController.preventDefault();
      this._historyController.goBackto(n);
      this._renderer.popTo(back);
      this.dispatch(location, &quot;POP&quot;, this, false);
    }
  }

  /**
   * Go back until the url
   *
   * @example
   * ...
   * router.goBacktoUrl(&apos;/back/to/url&apos;);
   * ...
   * @since 1.1.0
   * @param {string} url - An url will be matched in the same stack
   */
  goBacktoUrl(url) {
    this.goBackto(this.getStepLengthByCurrent(url));
  }

  /**
   * Go back to first page in the same stack
   *
   * @example
   * ...
   * router.goBackHome();
   * ...
   * @since 1.1.0
   */
  goBackHome() {
    const lastIndex = this._historyController.getLength() - 1;
    const index = this._historyController.currentIndex();
    const back = index - (lastIndex - index);
    this.goBackto(-back);
  }

  /**
   * Returns length of the history steps to be needed to receive from current to specified url
   *
   * @param {string} url
   * @return {number}
   */
  getStepLengthByCurrent(url) {
    const lastIndex = this._historyController.getLength() - 1;
    const index = this._historyController.findIndex(
      location =&gt; location.url === url
    );

    return index - lastIndex;
  }

  /**
   * Tests if desired url is available to go back or not
   *
   * @param {string} url Desired url to test availability to go back
   * @return {boolean}
   */
  canGoBacktoUrl(url) {
    return this.canGoBackto(this.getStepLengthByCurrent(url));
  }

  resetView() {
    this.clearUrl();
    this._currentRouteUrl = null;
    this._renderer.setChildControllers([]);
    this._historyController.clear();
  }
}

module.exports = NativeStackRouter;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
