<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/common/createHistory.js | Smartface NativeRouter</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Smartface NativeRouter"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Smartface NativeRouter"><meta property="twitter:description" content="Smartface NativeRouter"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/smartface/router"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-History">History</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-HistoryListener">HistoryListener</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteBuildHandler">RouteBuildHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteShouldMatchHandler">RouteShouldMatchHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouterBlockHandler">RouterBlockHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.BottomTabBarController">BottomTabbarController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.Color">Color</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.Image">Image</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.NavigationController">NavigationController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.Page">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://docs.smartface.io/#!/api/UI.TabBarItem">TabBarItem</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#common">common</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createHistory">createHistory</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#native">native</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/AndroidRenderer.js~AndroidRenderer.html">AndroidRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/BottomTabBarRouter.js~BottomTabBarRouter.html">BottomTabBarRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/IOSRenderer.js~IOSRenderer.html">IOSRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/NativeRouter.js~NativeRouter.html">NativeRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/NativeRouterBase.js~NativeRouterBase.html">NativeRouterBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/NativeStackRouter.js~NativeStackRouter.html">NativeStackRouter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/native/Renderer.js~Renderer.html">Renderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createTabBarItem">createTabBarItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BottomTabBarItem">BottomTabBarItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BottomTabBarRouterParams">BottomTabBarRouterParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-HeaderBarParams">HeaderBarParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NativeStackRouterParams">NativeStackRouterParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NavigationControllerTransformEvent">NavigationControllerTransformEvent</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#router">router</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/router/Route.js~Route.html">Route</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/router/Route.js~RoutePath.html">RoutePath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/router/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteLocation">RouteLocation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteMatch">RouteMatch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteParams">RouteParams</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouteState">RouteState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RouterParams">RouterParams</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/common/createHistory.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&quot;use strict&quot;;
const createMemoryHistory = require(&quot;./history&quot;);
const { matchUrl } = require(&quot;./matchPath&quot;);
let rootHistory;

/**
 * Creates a new HistoryController instance
 *
 * @param {{?initialEntries: Array, ?initialIndex: number, ?keyLength: number, ?getUserConfirmation: function, sensitive: boolean, strict: boolean}} param0
 * @return {HistoryController}
 */
function createHistory({
  initialEntries = null,
  initialIndex = null,
  keyLength = null,
  getUserConfirmation = null,
  exact = false,
  sensitive = true,
  strict = false,
  path
} = {}) {
  let routeBlocker = (blockerFn, callback) =&gt; {
    // console.log(`--- routeBlocker ${blockerFn} ${_preventDefault}`);
    _preventDefault === false &amp;&amp; getUserConfirmation
      ? getUserConfirmation(blockerFn, callback)
      : callback(true);
  };

  let _preventDefault;
  const _options = {
    exact,
    sensitive,
    strict,
    path
  };
  /**
   * @type {History}
   */
  let _history = createMemoryHistory({
    initialEntries: initialEntries || [], // The initial URLs in the history stack
    initialIndex: initialIndex || 0, // The starting index in the history stack
    keyLength: keyLength || 20, // The length of location.key
    // A function to use to confirm navigation with the user. Required
    // if you return string prompts from transition hooks (see below)
    getUserConfirmation: routeBlocker
  });

  const _listeners = new Set();
  const _unlistenAll = new Set();
  const _nodes = new Set();
  let _prompt = null;
  let _unblock;

  function listener(location, action) {
    _preventDefault === false &amp;&amp;
      _listeners.forEach(handler =&gt; handler(location, action));
    _preventDefault = false;
  }

  /**
   * History wrapper
   * @access package
   * @class HistoryController
   */
  class HistoryController {
    constructor() {}

    clearBlocker() {
      _unblock &amp;&amp; _unblock();
    }

    /**
     * Prevent history change event
     */
    preventDefault() {
      _preventDefault = true;
    }

    clearPreventDefault() {
      _preventDefault = false;
    }

    block(prompt) {
      _prompt = prompt;
      this.clearBlocker();
      _unblock = _history.block(_prompt);

      return () =&gt; {
        _prompt = null;
        _unblock();
      };
    }

    clear() {
      _history.clear();
    }

    getHistoryasArray() {
      return _history.entries.map(item =&gt; item.url);
    }

    /**
     * @param {object} [={}] props Node properties
     * @return {HistoryController}
     */
    createNode(props = {}) {
      const node = createHistory(props, this);
      _nodes.add(node);
      // bubbles history goback to root if go back could be possible.
      node.onGoBack = () =&gt; {
        // console.log(`on go back ${JSON.stringify(this.getHistoryasArray())} ${_history.index}`);
        if (_history.canGo(-1)) {
          // _listeners.forEach(listener =&gt; listener(_history.location, &apos;POP&apos;))
          _history.go(-1);
        } else {
          this.onGoBack &amp;&amp; this.onGoBack();
        }
      };
      // bubbles the last push up to root until pushing can be possible.
      node.onPush = (path, data) =&gt; {
        if (this.canPush(path)) {
          this.push(path, data);
        } else {
          this.onPush &amp;&amp; this.onPush(path, data);
        }
      };

      return node;
    }

    get lastLocation() {
      return _history.location;
    }

    /**
     * Return all nodes
     * @return {Set&lt;HistoryController&gt;}
     */
    get nodes() {
      return new Set(_nodes);
    }

    /**
     * @return {History}
     */
    get history() {
      return _history;
    }

    pushLocation(location) {
      _history.push(location);
    }

    /**
     * Removes last history entry
     *
     * @todo notify all listeners as action is rollback
     */
    rollback() {
      _preventDefault = true;
      _history.rollback();
      _preventDefault = false;
    }

    /**
     * Disposes history
     */
    dispose() {
      _history = null;
    }

    /**
     * If the url is available to push or not.
     *
     * @param {string} url - Url will be pushed.
     */
    canPush(url) {
      const res = matchUrl(url, _options);
      return res !== null;
    }

    /**
     * Pushes a new url to history
     *
     * @param {string} url - Url will be pushed.
     * @param {object} routeData - Requested route data
     */
    push(url, routeData = {}) {
      this.canPush(url)
        ? _history.push(url, routeData)
        : !_preventDefault &amp;&amp;
          this.onPush &amp;&amp;
          this.onPush(url, routeData, _prompt);
      _preventDefault &amp;&amp; this.clearPreventDefault();
    }

    /**
     * If history can be gone back or not
     * @param {number} n it&apos;s a negative number to go bac
     *
     * @return boolean
     */
    canGoBack(n=-1) {
      return _history.canGo(n);
    }
    
    goBackto(n){
      _history.go(n) 
      _preventDefault &amp;&amp; this.clearPreventDefault();
    }
    
    currentIndex(){
      return _history.index;
    }

    /**
     * Calls History.goBack
     */
    goBack() {
      _history.canGo(-1)
        ? _history.goBack()
        : !_preventDefault &amp;&amp; this.onGoBack &amp;&amp; this.onGoBack();
      _preventDefault &amp;&amp; this.clearPreventDefault();
    }
    
    getLength(){
      return _history.length
    }

    /**
     * Adds history change handler and returns unlisten function
     *
     * @param {HistoryListener} fn Event handler callback
     * @return {function} unlisten function
     */
    listen(fn) {
      const unlisten = new Set();

      _listeners.add(fn);
      const wrapper = (location, action) =&gt; {
        !_preventDefault &amp;&amp;
          fn(location, action, _history.entries[_history.index]);
      };
      unlisten.add(_history.listen(wrapper));
      unlisten.forEach(item =&gt; _unlistenAll.add(item));
      return () =&gt; {
        unlisten.forEach(item =&gt; {
          item();
          _unlistenAll.delete(item);
        });
        _listeners.delete(fn);
      };
    }
    
    findIndex(fn){
      return _history.entries.findIndex(fn);
    }

    find(fn){
      return _history.entries.find(fn);
    }

    /**
     * Returns string representation of an instance
     *
     * @return {string}
     */
    toString() {
      return `[Object HistoryController, 
        stack: ${JSON.stringify(this.getHistoryasArray())}, 
        length ${_history.length}, 
        index : ${_history.index}]`;
    }

    /**
     * Disposes a instance
     */
    dispose() {
      _nodes.forEach(node =&gt; node.dispose());
      _unlistenAll.forEach(item =&gt; item());
      _unlistenAll.clear();
      _listeners.clear();
      _history = null;
      this.onGoBack = null;
    }
  }

  return new HistoryController();
}

module.exports = createHistory;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
